<div class="container mt-4">
  <!-- Banner e información principal de la comunidad -->
  <div class="text-center mb-5">
    <img
      *ngIf="community?.banner"
      [src]="community?.banner"
      class="img-fluid rounded mb-3"
      alt="Banner"
    />

    <div class="d-flex justify-content-center align-items-center gap-3">
      <img
        *ngIf="community?.image"
        [src]="community?.image"
        alt="Avatar"
        class="rounded-circle"
        width="80"
        height="80"
      />
      <div>
        <h2 class="mb-0">{{ community?.name }}</h2>
        <small class="text-muted">#{{ community?.tags?.join(", ") }}</small>
      </div>
    </div>

    <!-- Botones para ver reglas y descripción -->
    <div class="mt-3 accordion" id="communityAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#rulesCollapse"
            aria-expanded="false"
            aria-controls="rulesCollapse"
          >
            Ver reglas
          </button>
        </h2>
        <div
          id="rulesCollapse"
          class="accordion-collapse collapse"
          data-bs-parent="#communityAccordion"
        >
          <div class="accordion-body">
            <div
              class="quill-content"
              [innerHTML]="
                community?.rules || 'Esta comunidad no tiene reglas públicas.'
              "
            ></div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#descriptionCollapse"
            aria-expanded="false"
            aria-controls="descriptionCollapse"
          >
            Ver descripción
          </button>
        </h2>
        <div
          id="descriptionCollapse"
          class="accordion-collapse collapse"
          data-bs-parent="#communityAccordion"
        >
          <div class="accordion-body">
            <div
              class="quill-content"
              [innerHTML]="
                community?.description ||
                'Esta comunidad no tiene descripción pública.'
              "
            ></div>
          </div>
        </div>
      </div>
    </div>

    <hr />

    <div class="row">
      <!-- Columna lateral con perfil del usuario en esta comunidad -->
      <div class="col-md-3 mb-4">
        <div class="card text-center">
          <div class="card-body">
            <img
              *ngIf="profile?.profileImage"
              [src]="profile?.profileImage"
              alt="Perfil"
              class="rounded-circle mb-2"
              width="70"
              height="70"
            />
            <h5 class="card-title">{{ profile?.username }}</h5>
            <button
              class="btn btn-outline-primary w-100 mt-2"
              (click)="viewProfile(profile!.id)"
            >
              Ver perfil
            </button>
          </div>
        </div>

        <!-- Opciones de la comunidad -->
        <div class="card mt-4">
          <div class="card-body">
            <h6>Opciones</h6>
            <ul class="list-unstyled">
              <li>
                <button
                  type="button"
                  class="btn btn-primary d-block py-1 w-100"
                  (click)="goToCreatePost()"
                >
                  Crear publicación
                </button>
              </li>

              <br />

              <li>
                <button
                  class="btn btn-outline-primary"
                  (click)="loadCommunityMembers()"
                >
                  Ver miembros
                </button>
              </li>

              <br />

              <li>
                <button
                  class="btn btn-outline-primary"
                  (click)="goToSearchPosts()"
                >
                  Buscar publicaciones
                </button>
              </li>

              <br />

              <li>
                <button
                  class="btn btn-outline-primary"
                  (click)="goToNotifications()"
                >
                  Ver notificaciones
                  <span *ngIf="unreadCount > 0" class="badge bg-danger ms-2">{{
                    unreadCount
                  }}</span>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Columna principal con los posts -->
      <div class="col-md-9">
        <h4>Publicaciones recientes</h4>
        <div *ngIf="posts.length > 0; else noPosts">
          <div
            *ngFor="let post of posts.slice().reverse()"
            class="card mb-3"
            style="cursor: pointer"
            (click)="goToPostDetail(post.id)"
          >
            <div class="card-body">
              <!-- Perfil del autor -->
              <div
                class="d-flex align-items-center mb-2"
                style="cursor: pointer"
                (click)="
                  viewProfile(post.communityProfile.id);
                  $event.stopPropagation()
                "
              >
                <img
                  *ngIf="post.communityProfile?.profileImage"
                  [src]="post.communityProfile.profileImage"
                  alt="Avatar"
                  class="rounded-circle me-2"
                  width="40"
                  height="40"
                />
                <h6 class="mb-0">{{ post.communityProfile.username }}</h6>
              </div>

              <!-- Título -->
              <h5 class="card-title">{{ post.title }}</h5>

              <!-- 🔽 Contenido completo -->
              <div
                class="card card-body mb-2 text-start"
                *ngIf="post.showContent"
              >
                <div class="quill-content" [innerHTML]="post.content"></div>
              </div>

              <div class="text-center">
                <button
                  class="btn btn-sm btn-outline-secondary mt-2"
                  (click)="toggleContent(post); $event.stopPropagation()"
                >
                  {{ post.showContent ? "Ver menos" : "Ver más" }}
                </button>
              </div>

              <!-- Tags -->
              <div class="mb-2">
                <span
                  class="badge bg-primary me-1"
                  *ngFor="let tag of post.tags"
                >
                  {{ tag }}
                </span>
              </div>

              <!-- Likes y comentarios -->
              <div class="text-end">
                <small class="text-muted">{{ post.likes }} 💙</small> |
                <small class="text-muted">{{ post.coments }} 💬</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noPosts>
        <p>No hay publicaciones en esta comunidad todavía.</p>
      </ng-template>
    </div>

    <div class="modal fade show d-block" tabindex="-1" *ngIf="showMembersModal">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Miembros de la comunidad</h5>
            <button
              type="button"
              class="btn-close"
              (click)="showMembersModal = false"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              class="form-control mb-3"
              placeholder="Buscar por nombre..."
              [(ngModel)]="searchTerm"
              (input)="filterMembers()"
            />
            <div *ngIf="filteredMembers.length === 0">
              No se encontraron miembros.
            </div>
            <div *ngFor="let member of filteredMembers">
              <img
                [src]="member.profileImage"
                width="40"
                class="rounded-circle me-2"
              />
              {{ member.username }}
              <button
                class="btn btn-sm btn-link"
                (click)="viewProfile(member.id)"
              >
                Ver perfil
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              (click)="showMembersModal = false"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show" *ngIf="showMembersModal"></div>
  </div>
</div>
